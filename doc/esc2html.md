# Technical Overview

## Project Summary

This project provides command-line and web-based tools for parsing and converting ESC/POS binary data, commonly used in receipt printers, into human-readable formats such as HTML, plain text, and images. The tools are packaged with a Dockerfile for easy deployment as a web service.

---

## Architecture Diagram

```
+-------------------+        +---------------------+        +-------------------+
|  Client (Browser) | <----> |  Web Service (PHP)  | <----> |  ESC/POS Parser   |
+-------------------+        +---------------------+        +-------------------+
        |                            |                               |
        |   HTTP POST (ESC/POS data) |                               |
        |--------------------------->|                               |
        |                            |  Parses ESC/POS binary        |
        |                            |------------------------------>|
        |                            |  Generates HTML/Text/Images   |
        |                            |<------------------------------|
        |   Receives HTML response   |                               |
        |<--------------------------|                               |
```

---

## Code Explanation

- **Language:** PHP (requires PHP 5.6+ with `mbstring` and `imagick` extensions)
- **Key Components:**
  - **ESC/POS Parser:** Reads binary ESC/POS data, extracts commands, and renders output.
  - **Web Service (`esc2html_service.php`):** Accepts HTTP POST requests with ESC/POS data, invokes the parser, and returns HTML.
  - **Utilities:** Command-line tools like `esc2text`, `esc2html`, and `escimages` for different output formats.
- **Docker Integration:** The project includes a Dockerfile for building a containerized web service, exposing the HTML conversion endpoint.

---

## esc2html Web Service Flow

1. **Request:**  
   The client (e.g., a JavaScript app) sends a POST request to `esc2html_service.php` with:
   - `esc`: Base64-encoded ESC/POS binary data
   - `width`: Desired output width

2. **Processing:**  
   - The PHP service decodes the ESC/POS data.
   - The parser interprets ESC/POS commands (text, images, formatting).
   - HTML is generated to visually represent the receipt.

3. **Response:**  
   - The service returns the generated HTML, which can be displayed directly in the browser.

---

## esc2html

`esc2html` converts an ESC/POS binary file into a HTML document. It is currently capable of rendering some types of formatting and images, plus any ASCII text in the input file.

```
$ php esc2html.php receipt-with-logo.bin > output.html
```

### Installation

This utility is included with escpos-tools. See the
[escpos-tools documentation](https://github.com/receipt-print-hq/escpos-tools) for installation instructions.

### Usage

```
php esc2html FILE
```

### Example

```
$ php esc2html.php receipt-with-logo.bin > receipt-with-logo.html
```

The HTML representation of the receipt is saved to a new file, and appears as:

![receipt-with-logo-img.png](https://raw.githubusercontent.com/receipt-print-hq/escpos-tools/master/doc/receipt-with-logo-html.png)

The same binary data, when sent to a printer, renders as below:

```
$ cat receipt-with-logo.bin > /dev/usb/lp0
```

![receipt-with-logo-small.png](https://raw.githubusercontent.com/receipt-print-hq/escpos-tools/master/doc/receipt-with-logo-small.png)

The input file used as an example here was generated by [escpos-php](https://github.com/mike42/escpos-php), and is available [here](https://raw.githubusercontent.com/receipt-print-hq/escpos-tools/master/receipt-with-logo.bin).

### Further conversions

This utility will create a formatted HTML file. This can be converted accurately to PDF
via `wkhtmltopdf`, where formatted plaintext can be subsequently extracted via
`pdftotext -f -nopagebrk`, or images can be extracted via `pdfimages`. If some text
is embedded in the finished document as an image, then `pdfsandwich` can apply optical
character recognition to this.

Alternatively, the HTML may be converted accurately to a raster image via `wkhtmltoimage`.

The correct layout of the HTML document partially depends on the use of CSS3, so the
use of document converters such as `unoconv` and `pandoc` tends to lose some information.

These can can be used to produce RTF, DOC, and some other formats if the lossy conversion
is acceptable.

---

## Repository

- **GitHub:** [https://github.com/receipt-print-hq/escpos-tools](https://github.com/receipt-print-hq/escpos-tools)

---

## Language & Compilers

- **Language:** PHP
- **Required Extensions:** `mbstring`, `imagick`
- **Composer:** Used for dependency management
- **Docker:** Used for containerization (no compilation needed, interpreted by PHP runtime)

---

## Recommendations, Limitations, and Possible Improvements

**Recommendations:**
- Use Docker for consistent environment setup.
- Always keep `composer.lock` and dependencies updated.
- Add comprehensive unit and integration tests for all ESC/POS command variants.

**Limitations:**
- Not all ESC/POS commands or manufacturer-specific extensions may be supported.
- Some advanced graphics or barcode modes may not render identically to real printers.
- Performance may degrade with very large or complex ESC/POS files.

**Possible Improvements:**
- Expand support for more ESC/POS command sets, especially for 2D barcodes and advanced graphics.
- Modularize the parser for easier extension and maintenance.
- Add support for more printer models and code pages.
- Improve error handling and reporting for unsupported or malformed ESC/POS data.

---

## Similarities with Epson L90 and Bixolon SP300

- **ESC/POS Compatibility:** Both Epson L90 and Bixolon SP300 use the ESC/POS command set, so most basic text, formatting, and image commands are supported by this tool.
- **Code Pages & Fonts:** The parser can handle standard code pages and font commands used by these models.
- **Graphics:** Basic raster and bit image commands are supported, which are common in both printers.
- **Limitations:** Manufacturer-specific extensions or proprietary commands unique to Epson or Bixolon may not be fully supported without further parser extension.

---

## See also

- [esc2text](esc2text.md)
- [escimages](escimages.md)